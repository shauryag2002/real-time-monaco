"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RealTimeMonaco=void 0;var e=require("tslib"),o=require("react/jsx-runtime"),r=require("react"),n=e.__importDefault(require("@monaco-editor/react")),t=e.__importStar(require("yjs")),a=require("y-websocket"),s=require("y-monaco"),l=require("react"),i=e.__importStar(require("monaco-editor"));require("./styles.css");exports.RealTimeMonaco=function(u){var c=e.__rest(u,[]),d=(0,r.useState)([]),v=d[0],m=d[1],f=(0,r.useState)(),g=f[0],_=f[1],p=(0,r.useState)(),y=p[0],h=p[1],S=(0,l.useRef)(),C=(0,r.useState)({name:c.name,color:c.color}),b=C[0];C[1];var N=(0,r.useState)(!1),w=N[0],q=N[1],x=(0,r.useState)([]),T=x[0],A=x[1],k=[],M=(0,r.useState)([]),E=M[0],L=M[1],I={name:c.name,color:c.color,collaborateId:c.roomId},j=I.name,D=I.color,R=I.collaborateId;(0,r.useEffect)((function(){if(w&&j){var e=document.getElementsByClassName("applyColorToThis"),o=document.getElementsByClassName("my-cursor"),r="backgroundC-";t(e,r,!1),t(o,r,!0);var n=setInterval((function(){t(e,r,!1),t(o,r,!0)}),1);return function(){return clearInterval(n)}}function t(e,o,r){for(var n=function(n){e[n].className.split(" ").forEach((function(t){var a,s,l;if(-1!==t.indexOf(o)){var i=t.replace(o,"");if((null==b?void 0:b.color)!=="#".concat(i))if(r&&!e[n].textContent){var u=v.findIndex((function(e){var o;return(null===(o=e.user)||void 0===o?void 0:o.color)==="#".concat(i)}));e[n].innerHTML="",function(e,o,r){var n=document.createElement("div");n.style.background="#".concat(o),n.textContent=r,n.setAttribute("class","cursor-hover"),e.appendChild(n)}(e[n],i,null!==(l=null===(s=null===(a=v[u])||void 0===a?void 0:a.user)||void 0===s?void 0:s.name)&&void 0!==l?l:"#".concat(i))}else!function(e,o){e.style.background="#".concat(o)}(e[n],i)}}))},t=0;t<e.length;t++)n(t)}}),[v,j]);var O=function(o){var r=o.position,n=null==y?void 0:y.getLocalState();null==y||y.setLocalState(e.__assign(e.__assign({},n),{user:{name:j,color:D},cursor:r}))},B=function(o){var r=o.selection,n=null==y?void 0:y.getLocalState();n=e.__assign(e.__assign({},n),{user:{name:j,color:D}}),null==y||y.setLocalState(e.__assign(e.__assign({},n),{user:{name:j,color:D},selection:r}))};function P(o){var r;q(!0),S.current=o;var n=new t.Doc,l=R,u=new a.WebsocketProvider("wss://demos.yjs.dev/ws",l,n),c=n.getText("monaco"),d=u.awareness;h(d),d.on("change",(function(){for(var r,n,t=Array.from(d.getStates().values()),a=[],s=[],l=[],u=0;u<t.length;u++){var c=t[u].cursor,v=t[u].selection,m=null===(r=t[u].user)||void 0===r?void 0:r.color,f=null===(n=t[u].user)||void 0===n?void 0:n.name;c&&a.push(c),v&&s.push(v),l.push(m),L(e.__spreadArray(e.__spreadArray([],E,!0),[f],!1))}(function(e,o,r,n){for(var t,a,s=[],l=0;l<o.length;l++){var u=o[l];s.push({range:new i.Range(u.lineNumber,u.column,u.lineNumber,u.column),options:{className:" applyColorToThis ".concat((null==b?void 0:b.color)===r[l]?"":"my-cursor"," backgroundC-").concat(null===(t=r[l])||void 0===t?void 0:t.slice(1))}})}for(l=0;l<(null==e?void 0:e.length);l++)null!==(u=e[l])&&s.push({range:new i.Range(u.startLineNumber,u.startColumn,u.endLineNumber,u.endColumn),options:{className:"".concat((null==b?void 0:b.color)===r[l]?"":"applyColorToThis"," backgroundC-").concat(null===(a=r[l])||void 0===a?void 0:a.slice(1))}});k=null==n?void 0:n.deltaDecorations(k,s)})(s,a,l=e.__spreadArray(e.__spreadArray([],l,!0),l,!0),o),A(e.__spreadArray(e.__spreadArray([],T,!0),l,!0))}));var v=null===(r=S.current)||void 0===r?void 0:r.getModel();v&&new s.MonacoBinding(c,v,new Set([S.current]))}return(0,r.useEffect)((function(){g&&w&&(j&&(null==g||g.onDidChangeCursorPosition(O),null==g||g.onDidChangeCursorSelection(B)),y&&y.on("update",(function(){var e=Array.from(y.getStates().values());JSON.stringify(e)!==JSON.stringify(v)&&m(e)})))}),[g,w,j]),(0,r.useEffect)((function(){g&&R&&j&&P(g)}),[g,R,j]),(0,o.jsx)(n.default,e.__assign({theme:"vs-dark",onMount:function(e){_(e)},className:"monaco-editor",options:{wordWrap:"on",smoothScrolling:!0,glyphMargin:!0}},c||{}))};

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RealTimeMonaco=void 0;var e=require("tslib"),o=require("react/jsx-runtime"),n=require("react"),r=e.__importDefault(require("@monaco-editor/react")),t=e.__importStar(require("yjs")),a=require("y-websocket"),s=require("y-monaco"),l=require("react"),i=e.__importStar(require("monaco-editor"));require("./styles.css");exports.RealTimeMonaco=function(c){var u=e.__rest(c,[]),d=(0,n.useState)([]),v=d[0],m=d[1],f=(0,n.useState)(),g=f[0],_=f[1],p=(0,n.useState)(),y=p[0],h=p[1],S=(0,l.useRef)(),C=(0,n.useState)({name:u.name,color:u.color}),b=C[0];C[1];var N=(0,n.useState)(!1),w=N[0],q=N[1],x=(0,n.useState)([]),T=x[0],A=x[1],k=[],E=(0,n.useState)([]),M=E[0],L=E[1],I={name:u.name,color:u.color,collaborateId:u.roomId},j=I.name,D=I.color,R=I.collaborateId;(0,n.useEffect)((function(){if(w&&j){var e=document.getElementsByClassName("applyColorToThis"),o=document.getElementsByClassName("my-cursor"),n="backgroundC-";t(e,n,!1),t(o,n,!0);var r=setInterval((function(){t(e,n,!1),t(o,n,!0)}),1);return function(){return clearInterval(r)}}function t(e,o,n){for(var r=function(r){e[r].className.split(" ").forEach((function(t){var a,s,l;if(-1!==t.indexOf(o)){var i=t.replace(o,"");if((null==b?void 0:b.color)!=="#".concat(i))if(n&&!e[r].textContent){var c=v.findIndex((function(e){var o;return(null===(o=e.user)||void 0===o?void 0:o.color)==="#".concat(i)}));e[r].innerHTML="",function(e,o,n){var r=document.createElement("div");r.style.background="#".concat(o),r.textContent=n,r.setAttribute("class","cursor-hover"),e.appendChild(r)}(e[r],i,null!==(l=null===(s=null===(a=v[c])||void 0===a?void 0:a.user)||void 0===s?void 0:s.name)&&void 0!==l?l:"#".concat(i))}else!function(e,o){e.style.background="#".concat(o)}(e[r],i)}}))},t=0;t<e.length;t++)r(t)}}),[v,j]);var O=function(o){var n=o.position,r=null==y?void 0:y.getLocalState();null==y||y.setLocalState(e.__assign(e.__assign({},r),{user:{name:j,color:D},cursor:n}))},B=function(o){var n=o.selection,r=null==y?void 0:y.getLocalState();r=e.__assign(e.__assign({},r),{user:{name:j,color:D}}),null==y||y.setLocalState(e.__assign(e.__assign({},r),{user:{name:j,color:D},selection:n}))};function P(o){var n;q(!0),S.current=o;var r=new t.Doc,l=R,c=new a.WebsocketProvider("wss://demos.yjs.dev/ws",l,r),u=r.getText("monaco"),d=c.awareness;h(d),d.on("change",(function(){for(var n,r,t=Array.from(d.getStates().values()),a=[],s=[],l=[],c=0;c<t.length;c++){var u=t[c].cursor,v=t[c].selection,m=null===(n=t[c].user)||void 0===n?void 0:n.color,f=null===(r=t[c].user)||void 0===r?void 0:r.name;u&&a.push(u),v&&s.push(v),l.push(m),L(e.__spreadArray(e.__spreadArray([],M,!0),[f],!1))}(function(e,o,n,r){for(var t,a,s=[],l=0;l<o.length;l++){var c=o[l];s.push({range:new i.Range(c.lineNumber,c.column,c.lineNumber,c.column),options:{className:" applyColorToThis ".concat((null==b?void 0:b.color)===n[l]?"":"my-cursor"," backgroundC-").concat(null===(t=n[l])||void 0===t?void 0:t.slice(1))}})}for(l=0;l<(null==e?void 0:e.length);l++)null!==(c=e[l])&&s.push({range:new i.Range(c.startLineNumber,c.startColumn,c.endLineNumber,c.endColumn),options:{className:"".concat((null==b?void 0:b.color)===n[l]?"":"applyColorToThis"," backgroundC-").concat(null===(a=n[l])||void 0===a?void 0:a.slice(1))}});k=null==r?void 0:r.deltaDecorations(k,s)})(s,a,l=e.__spreadArray(e.__spreadArray([],l,!0),l,!0),o),A(e.__spreadArray(e.__spreadArray([],T,!0),l,!0))}));var v=null===(n=S.current)||void 0===n?void 0:n.getModel();v&&new s.MonacoBinding(u,v,new Set([S.current]))}return(0,n.useEffect)((function(){g&&w&&(j&&(null==g||g.onDidChangeCursorPosition(O),null==g||g.onDidChangeCursorSelection(B)),y&&y.on("update",(function(){var e=Array.from(y.getStates().values());JSON.stringify(e)!==JSON.stringify(v)&&m(e)})))}),[g,w,j]),(0,n.useEffect)((function(){g&&R&&j&&P(g)}),[g,R,j]),(0,n.useEffect)((function(){console.log("allUsers",v)}),[v]),(0,o.jsx)(r.default,e.__assign({theme:"vs-dark",onMount:function(e){_(e)},className:"monaco-editor",options:{wordWrap:"on",smoothScrolling:!0,glyphMargin:!0}},u||{}))};

Object.defineProperty(exports,"__esModule",{value:!0}),exports.RealTimeMonaco=void 0;var e=require("tslib"),o=require("react/jsx-runtime"),n=require("react"),r=e.__importDefault(require("@monaco-editor/react")),t=e.__importStar(require("yjs")),a=require("y-websocket"),s=require("y-monaco"),l=require("react"),u=e.__importStar(require("monaco-editor"));require("./styles.css");exports.RealTimeMonaco=function(i){var c=e.__rest(i,[]),d=(0,n.useState)([]),v=d[0],m=d[1],f=(0,n.useState)(),_=f[0],g=f[1],p=(0,n.useState)(),y=p[0],h=p[1],S=(0,l.useRef)(),C=(0,n.useState)({name:c.name,color:c.color}),b=C[0];C[1];var N=(0,n.useState)(!1),q=N[0],w=N[1],x=(0,n.useState)([]),T=x[0],A=x[1],M=[],k=(0,n.useState)([]),E=k[0],L=k[1],I=(0,n.useState)(),j=I[0],D=I[1],R={name:c.name,color:c.color,collaborateId:c.roomId},O=R.name,B=R.color,P=R.collaborateId;(0,n.useEffect)((function(){if(q&&O){var e=document.getElementsByClassName("applyColorToThis"),o=document.getElementsByClassName("my-cursor"),n="backgroundC-";t(e,n,!1),t(o,n,!0);var r=setInterval((function(){t(e,n,!1),t(o,n,!0)}),1);return function(){return clearInterval(r)}}function t(e,o,n){for(var r=function(r){e[r].className.split(" ").forEach((function(t){var a,s,l;if(-1!==t.indexOf(o)){var u=t.replace(o,"");if((null==b?void 0:b.color)!=="#".concat(u))if(n&&!e[r].textContent){var i=v.findIndex((function(e){var o;return(null===(o=e.user)||void 0===o?void 0:o.color)==="#".concat(u)}));e[r].innerHTML="",function(e,o,n){var r=document.createElement("div");r.style.background="#".concat(o),r.textContent=n,r.setAttribute("class","cursor-hover"),e.appendChild(r)}(e[r],u,null!==(l=null===(s=null===(a=v[i])||void 0===a?void 0:a.user)||void 0===s?void 0:s.name)&&void 0!==l?l:"#".concat(u))}else!function(e,o){e.style.background="#".concat(o)}(e[r],u)}}))},t=0;t<e.length;t++)r(t)}}),[v,O]);var J=function(o){var n=o.position,r=null==y?void 0:y.getLocalState();null==y||y.setLocalState(e.__assign(e.__assign({},r),{user:{name:O,color:B},cursor:n}))},H=function(o){var n=o.selection,r=null==y?void 0:y.getLocalState();r=e.__assign(e.__assign({},r),{user:{name:O,color:B}}),null==y||y.setLocalState(e.__assign(e.__assign({},r),{user:{name:O,color:B},selection:n}))};function W(o){var n;w(!0),S.current=o;var r=new t.Doc,l=P,i=new a.WebsocketProvider("wss://demos.yjs.dev/ws",l,r),c=r.getText("monaco");D(c);var d=i.awareness;h(d),d.on("change",(function(){for(var n,r,t=Array.from(d.getStates().values()),a=[],s=[],l=[],i=0;i<t.length;i++){var c=t[i].cursor,v=t[i].selection,m=null===(n=t[i].user)||void 0===n?void 0:n.color,f=null===(r=t[i].user)||void 0===r?void 0:r.name;c&&a.push(c),v&&s.push(v),l.push(m),L(e.__spreadArray(e.__spreadArray([],E,!0),[f],!1))}(function(e,o,n,r){for(var t,a,s=[],l=0;l<o.length;l++){var i=o[l];s.push({range:new u.Range(i.lineNumber,i.column,i.lineNumber,i.column),options:{className:" applyColorToThis ".concat((null==b?void 0:b.color)===n[l]?"":"my-cursor"," backgroundC-").concat(null===(t=n[l])||void 0===t?void 0:t.slice(1))}})}for(l=0;l<(null==e?void 0:e.length);l++)null!==(i=e[l])&&s.push({range:new u.Range(i.startLineNumber,i.startColumn,i.endLineNumber,i.endColumn),options:{className:"".concat((null==b?void 0:b.color)===n[l]?"":"applyColorToThis"," backgroundC-").concat(null===(a=n[l])||void 0===a?void 0:a.slice(1))}});M=null==r?void 0:r.deltaDecorations(M,s)})(s,a,l=e.__spreadArray(e.__spreadArray([],l,!0),l,!0),o),A(e.__spreadArray(e.__spreadArray([],T,!0),l,!0))}));var v=null===(n=S.current)||void 0===n?void 0:n.getModel();v&&new s.MonacoBinding(c,v,new Set([S.current]))}(0,n.useEffect)((function(){_&&q&&(O&&(null==_||_.onDidChangeCursorPosition(J),null==_||_.onDidChangeCursorSelection(H)),y&&y.on("update",(function(){var e=Array.from(y.getStates().values());JSON.stringify(e)!==JSON.stringify(v)&&m(e)})))}),[_,q,O]),(0,n.useEffect)((function(){_&&P&&O&&W(_)}),[_,P,O]);var z=c.onMount,F=c.value,G=e.__rest(c,["onMount","value"]);return(0,n.useEffect)((function(){_&&F&&j&&(j.delete(0,j.length),j.insert(0,F))}),[F,_,j]),(0,o.jsx)(r.default,e.__assign({theme:"vs-dark",onMount:function(e,o){g(e),z&&z(e,o)},className:"monaco-editor"},G))};
